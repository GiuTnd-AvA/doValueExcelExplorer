DECLARE @Schema sysname = N'dbo';
DECLARE @Name   sysname = N'table0';  -- può essere anche una vista
DECLARE @obj    nvarchar(517) = QUOTENAME(@Schema) + N'.' + QUOTENAME(@Name);
DECLARE @objId  int, @isTable bit;

-- verifica esistenza e tipo
SELECT 
  @objId  = OBJECT_ID(@obj),
  @isTable = CASE WHEN OBJECTPROPERTY(OBJECT_ID(@obj),'IsUserTable') = 1 THEN 1 ELSE 0 END;

IF @objId IS NULL
BEGIN
    DECLARE @db sysname = DB_NAME();
    DECLARE @msg nvarchar(400) = N'Oggetto ' + @obj + N' non trovato nel DB ' + @db + N'.';
    THROW 50001, @msg, 1;
END;

-- INBOUND: chi dipende da @obj (view/proc/func/trigger ecc.)
SELECT 
  Direction  = 'INBOUND',
  RefDB      = DB_NAME(),
  RefSchema  = re.referencing_schema_name,
  RefObject  = re.referencing_entity_name,
  RefType    = re.referencing_class_desc,
  Detail     = NULL
FROM sys.dm_sql_referencing_entities(@obj, 'OBJECT') AS re

UNION ALL

-- OUTBOUND: oggetti referenziati da @obj (tabelle, viste, tipi, ecc.)
SELECT
  'OUTBOUND',
  COALESCE(re2.referenced_database_name, DB_NAME()),
  re2.referenced_schema_name,
  re2.referenced_entity_name,
  re2.referenced_class_desc,
  NULL
FROM sys.dm_sql_referenced_entities(@obj, 'OBJECT') AS re2

UNION ALL

-- INBOUND FK (solo se @obj è una TABELLA)
SELECT
  'INBOUND',
  DB_NAME(),
  s.name,
  t.name,
  'FOREIGN_KEY (child -> base)',
  fk.name
FROM sys.foreign_keys fk
JOIN sys.tables  t  ON fk.parent_object_id = t.object_id
JOIN sys.schemas s  ON t.schema_id = s.schema_id
WHERE @isTable = 1
  AND fk.referenced_object_id = @objId

UNION ALL

-- OUTBOUND FK (solo se @obj è una TABELLA)
SELECT
  'OUTBOUND',
  DB_NAME(),
  s2.name,
  t2.name,
  'FOREIGN_KEY (base -> referenced)',
  fk2.name
FROM sys.foreign_keys fk2
JOIN sys.tables  t2 ON fk2.referenced_object_id = t2.object_id
JOIN sys.schemas s2 ON t2.schema_id = s2.schema_id
WHERE @isTable = 1
  AND fk2.parent_object_id = @objId

ORDER BY Direction, RefType, RefSchema, RefObject;
