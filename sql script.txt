DECLARE @Schema sysname = N'dbo';
DECLARE @Table  sysname = N'table0';
DECLARE @obj    nvarchar(400) = QUOTENAME(@Schema) + N'.' + QUOTENAME(@Table);

IF OBJECT_ID(@obj, 'U') IS NULL
BEGIN
  RAISERROR('Tabella %s non trovata nel DB %s.', 16, 1, @obj, DB_NAME());
  RETURN;
END;

-- INBOUND: chi dipende dalla tabella (view/proc/func/trigger, ecc.)
SELECT
  Direction    = 'INBOUND',
  RefDB        = DB_NAME(),
  RefSchema    = re.referencing_schema_name,
  RefObject    = re.referencing_entity_name,
  RefType      = re.referencing_class_desc,
  Detail       = NULL
FROM sys.dm_sql_referencing_entities(@obj, 'OBJECT') AS re

UNION ALL

-- INBOUND: tabelle figlie con FK -> tabella base
SELECT
  'INBOUND',
  DB_NAME(),
  s.name,
  t.name,
  'FOREIGN_KEY (child -> base)',
  fk.name
FROM sys.foreign_keys fk
JOIN sys.tables  t  ON fk.parent_object_id = t.object_id
JOIN sys.schemas s  ON t.schema_id = s.schema_id
WHERE fk.referenced_object_id = OBJECT_ID(@obj)

UNION ALL

-- OUTBOUND: oggetti referenziati dalla tabella (computed/default/chiavi, ecc.)
SELECT
  'OUTBOUND',
  COALESCE(re2.referenced_database_name, DB_NAME()),
  re2.referenced_schema_name,
  re2.referenced_entity_name,
  re2.referenced_class_desc,
  NULL
FROM sys.dm_sql_referenced_entities(@obj, 'OBJECT') AS re2

UNION ALL

-- OUTBOUND: FK della tabella base verso altre tabelle
SELECT
  'OUTBOUND',
  DB_NAME(),
  s2.name,
  t2.name,
  'FOREIGN_KEY (base -> referenced)',
  fk2.name
FROM sys.foreign_keys fk2
JOIN sys.tables  t2  ON fk2.referenced_object_id = t2.object_id
JOIN sys.schemas s2  ON t2.schema_id = s2.schema_id
WHERE fk2.parent_object_id = OBJECT_ID(@obj)

ORDER BY Direction, RefType, RefSchema, RefObject;
